<script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        onSnapshot,
        query,
        serverTimestamp,
        deleteDoc,
        updateDoc,
        doc,
      } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
      // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô signInWithPopup ‡πÄ‡∏õ‡πá‡∏ô signInWithRedirect ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° getRedirectResult
      import {
        getAuth,
        GoogleAuthProvider,
        signInWithRedirect, 
        getRedirectResult,
        signOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

      // === 1. SETUP FIREBASE ===
      const firebaseConfig = {
        apiKey: "AIzaSyAhKMt2-wTBqCUCC4mzHjt8tWxCHBJXC5I",
        authDomain: "student-data-app-1c677.firebaseapp.com",
        projectId: "student-data-app-1c677",
        storageBucket: "student-data-app-1c677.firebasestorage.app",
        messagingSenderId: "575305259038",
        appId: "1:575305259038:web:2ed2df837feb093185f60f",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);
      const APP_ID = "Gukkghu-confession-wall"

      // === 2. AUTHENTICATION LOGIC ===
      const loginScreen = document.getElementById("loginScreen");
      const appContent = document.getElementById("appContent");
      let currentUser = null; 

      // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡πâ‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ Google (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö signInWithRedirect)
      getRedirectResult(auth)
        .then((result) => {
           // ‡∏ñ‡πâ‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏°‡∏±‡∏ô‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤ onAuthStateChanged ‡πÄ‡∏≠‡∏á ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        })
        .catch((error) => {
          console.error("Redirect Login Error:", error);
          alert("‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
        });

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô Redirect)
      window.signInWithGoogle = async () => {
        const provider = new GoogleAuthProvider();
        try {
          // ‡πÉ‡∏ä‡πâ Redirect ‡πÅ‡∏ó‡∏ô Popup ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Cross-Origin
          await signInWithRedirect(auth, provider);
        } catch (error) {
          console.error("Login Error:", error);
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
        }
      };

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏≠‡∏≤‡∏ó‡πå
      window.logout = async () => {
        if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
            try {
              await signOut(auth);
              window.location.reload(); 
            } catch (error) {
              console.error("Logout Error:", error);
              alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö");
            }
        }
      };

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ User (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)
      onAuthStateChanged(auth, (user) => {
        if (user) {
          // --- ‡∏°‡∏µ User Login ‡∏≠‡∏¢‡∏π‡πà ---
          currentUser = user;
          
          loginScreen.classList.add("hidden");
          appContent.classList.remove("hidden");
          setTimeout(() => {
              appContent.classList.remove("opacity-0");
          }, 50);
          
          document.getElementById("userDisplayName").innerText = user.displayName;
          document.getElementById("userEmailDisplay").innerText = user.email;
          document.getElementById("userAvatar").src = user.photoURL || "https://ui-avatars.com/api/?name=" + user.displayName;

          startApp();
        } else {
          // --- ‡πÑ‡∏°‡πà‡∏°‡∏µ User ---
          currentUser = null;
          appContent.classList.add("hidden");
          appContent.classList.add("opacity-0");
          loginScreen.classList.remove("hidden");
        }
      });

      // === 3. APP LOGIC (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ===
      let selectedColor = "yellow";
      const colorMap = {
        yellow: "bg-yellow-200 text-yellow-900 rotate-1",
        pink: "bg-pink-200 text-pink-900 -rotate-1",
        blue: "bg-sky-200 text-sky-900 rotate-2",
        green: "bg-green-200 text-green-900 -rotate-2",
      };

      function startApp() {
        const wallCollection = collection(
          db,
          "artifacts",
          APP_ID,
          "public",
          "data",
          "confessions"
        );

        const q = query(wallCollection);
        const wallContainer = document.getElementById("wallContainer");
        const loading = document.getElementById("loading");
        let notesData = [];

        onSnapshot(q, (snapshot) => {
            loading.style.display = "none";
            notesData = []; 

            snapshot.forEach((doc) => {
              notesData.push({ id: doc.id, ...doc.data() });
            });

            notesData.sort((a, b) => {
              const t1 = a.timestamp ? a.timestamp.seconds : 0;
              const t2 = b.timestamp ? b.timestamp.seconds : 0;
              return t2 - t1;
            });

            renderNotes(notesData);
          },
          (error) => {
            console.error("Snapshot error:", error);
          }
        );

        function renderNotes(notes) {
          wallContainer.innerHTML = "";
          if (notes.length === 0) {
              wallContainer.innerHTML = `<div class="col-span-full text-center text-white/50 py-10 text-xl font-light">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡∏¢... ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å‡∏™‡∏¥!</div>`;
              return;
          }
          notes.forEach((data) => {
            createNoteElement(data);
          });
        }

        function createNoteElement(data) {
          const noteId = data.id;
          const date = data.timestamp ? data.timestamp.toDate() : new Date();
          const div = document.createElement("div");
          div.id = `note-${noteId}`;
          const colorClass = colorMap[data.color] || colorMap["yellow"];

          div.className = `group p-6 rounded-lg shadow-md hover:shadow-xl transition duration-300 cursor-default note-enter relative min-h-[180px] flex flex-col justify-between ${colorClass}`;

          const rot = data.rotation || Math.random() * 6 - 3;
          div.style.setProperty("--rotation", `${rot}deg`);

          const isOwner = data.uid === currentUser.uid;
          
          const buttonsHtml = isOwner ? `
            <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                <button onclick="window.editConfession('${noteId}')" class="bg-white/50 hover:bg-white p-1 rounded-full text-sm w-8 h-8 flex items-center justify-center shadow-sm" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‚úèÔ∏è</button>
                <button onclick="window.deleteConfession('${noteId}')" class="bg-white/50 hover:bg-red-500 hover:text-white p-1 rounded-full text-sm w-8 h-8 flex items-center justify-center shadow-sm" title="‡∏•‡∏ö">üóëÔ∏è</button>
            </div>
          ` : `<div></div>`;

          const authorEmail = data.authorEmail || "Anonymous";
          const authorName = data.authorName || "‡∏ô‡∏¥‡∏£‡∏ô‡∏≤‡∏°";

          div.innerHTML = `
                <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 w-4 h-4 rounded-full bg-red-500 shadow-sm z-10 border border-red-700"></div>
                <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 w-1 h-1 bg-white/50 rounded-full z-20"></div>

                <div class="mb-4">
                     <p class="note-text text-xl font-medium leading-relaxed break-words">"${data.text}"</p>
                </div>
                
                <div class="mt-auto pt-2 border-t border-black/10">
                    <div class="flex items-center gap-2 mb-2 opacity-80">
                        <div class="w-6 h-6 rounded-full bg-black/10 flex items-center justify-center text-xs overflow-hidden font-bold text-black/50">
                             ${authorName.charAt(0)}
                        </div>
                        <div class="flex flex-col leading-none">
                            <span class="text-xs font-bold truncate max-w-[150px]">${authorName}</span>
                            <span class="text-[10px] opacity-70 truncate max-w-[150px]">${authorEmail}</span>
                        </div>
                    </div>

                    <div class="flex justify-between items-center h-8">
                        ${buttonsHtml}
                        <span class="text-xs font-bold opacity-60">
                            üïí ${timeAgo(date)}
                        </span>
                    </div>
                </div>
            `;
          wallContainer.appendChild(div);
        }

        window.postConfession = async () => {
          if (!currentUser) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
          const input = document.getElementById("messageInput");
          const text = input.value.trim();
          if (!text) {
            alert("‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏∞‡πÑ‡∏£‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏™‡∏¥!");
            return;
          }
          try {
            await addDoc(wallCollection, {
              text: text,
              color: selectedColor,
              timestamp: serverTimestamp(),
              rotation: Math.random() * 6 - 3,
              uid: currentUser.uid,
              authorEmail: currentUser.email,
              authorName: currentUser.displayName
            });
            input.value = "";
          } catch (error) {
            console.error(error);
            alert("‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏õ‡πÅ‡∏Æ‡∏∞: " + error.message);
          }
        };

        window.editConfession = async (id) => {
            const currentText = document.querySelector(`#note-${id} .note-text`).innerText.replace(/^"|"$/g, "");
            const newText = prompt("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°:", currentText);

            if (newText !== null && newText.trim() !== "") {
                try {
                    const noteRef = doc(db, "artifacts", APP_ID, "public", "data", "confessions", id);
                    await updateDoc(noteRef, { text: newText });
                } catch (error) {
                    console.error("Error updating: ", error);
                    alert("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå)");
                }
            }
        };

        window.deleteConfession = async (id) => {
            if (confirm("‡∏à‡∏∞‡∏â‡∏µ‡∏Å‡πÇ‡∏ô‡πâ‡∏ï‡∏ô‡∏µ‡πâ‡∏ó‡∏¥‡πâ‡∏á‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏´‡∏£‡∏≠?")) {
                try {
                    const noteRef = doc(db, "artifacts", APP_ID, "public", "data", "confessions", id);
                    await deleteDoc(noteRef);
                } catch (error) {
                    console.error("Error deleting: ", error);
                    alert("‡∏•‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå)");
                }
            }
        };
      }

      window.selectColor = (color) => {
        selectedColor = color;
        document.querySelectorAll(".color-btn").forEach((btn) => {
          btn.classList.remove("ring-2", "ring-white", "ring-offset-2", "ring-offset-gray-800");
          btn.classList.add("ring-transparent");
        });
        event.target.classList.remove("ring-transparent");
        event.target.classList.add("ring-2", "ring-white", "ring-offset-2", "ring-offset-gray-800");
      };

      function timeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        let interval = seconds / 31536000;
        if (interval > 1) return Math.floor(interval) + " ‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß";
        interval = seconds / 2592000;
        if (interval > 1) return Math.floor(interval) + " ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß";
        interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + " ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß";
        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + " ‡∏ä‡∏°.‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß";
        interval = seconds / 60;
        if (interval > 1) return Math.floor(interval) + " ‡∏ô‡∏≤‡∏ó‡∏µ‡∏Å‡πà‡∏≠‡∏ô";
        return "‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏µ‡πâ";
      }
    </script>
