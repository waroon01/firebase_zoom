<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Coffee Queue System ‚òï</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      body {
        font-family: "Kanit", sans-serif;
      }

      /* Animation ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Monitor */
      @keyframes pulse-ring {
        0% {
          transform: scale(0.8);
          box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
        }
        70% {
          transform: scale(1);
          box-shadow: 0 0 0 20px rgba(16, 185, 129, 0);
        }
        100% {
          transform: scale(0.8);
          box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
        }
      }
      .animate-pulse-ring {
        animation: pulse-ring 2s infinite;
      }

      /* Animation ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Customer Alert */
      @keyframes flash-green {
        0%,
        100% {
          background-color: #064e3b;
        }
        50% {
          background-color: #10b981;
        }
      }
      .bg-flash {
        animation: flash-green 1s infinite;
      }
    </style>
  </head>
  <body class="bg-stone-100 text-stone-800 h-screen overflow-hidden">
    <!-- === 1. LANDING PAGE (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î) === -->
    <div
      id="landing-page"
      class="h-full flex flex-col items-center justify-center p-4 space-y-6"
    >
      <div class="text-center mb-8">
        <div
          class="inline-block p-4 rounded-full bg-stone-800 text-amber-500 text-5xl mb-4 shadow-xl"
        >
          <i class="fa-solid fa-mug-hot"></i>
        </div>
        <h1 class="text-4xl font-bold text-stone-800">Fresh Brew Caf√©</h1>
        <p class="text-stone-500">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏ß‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡πÅ‡∏ü</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 w-full max-w-4xl">
        <!-- Customer Mode -->
        <button
          onclick="switchMode('customer')"
          class="group relative bg-white p-8 rounded-2xl shadow-lg hover:shadow-2xl transition-all border-b-4 border-amber-500 text-left"
        >
          <div
            class="absolute top-4 right-4 text-amber-500 opacity-20 group-hover:opacity-100 transition text-4xl"
          >
            <i class="fa-solid fa-user"></i>
          </div>
          <h2 class="text-xl font-bold text-stone-800">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Customer)</h2>
          <p class="text-sm text-stone-500 mt-2">
            ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏î‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å
          </p>
        </button>

        <!-- Monitor Mode -->
        <button
          onclick="switchMode('monitor')"
          class="group relative bg-stone-800 p-8 rounded-2xl shadow-lg hover:shadow-2xl transition-all border-b-4 border-emerald-500 text-left"
        >
          <div
            class="absolute top-4 right-4 text-emerald-500 opacity-20 group-hover:opacity-100 transition text-4xl"
          >
            <i class="fa-solid fa-tv"></i>
          </div>
          <h2 class="text-xl font-bold text-white">‡∏à‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (Monitor)</h2>
          <p class="text-sm text-gray-400 mt-2">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ñ‡∏≤‡∏ô‡πå‡πÄ‡∏ï‡∏≠‡∏£‡πå</p>
        </button>

        <!-- Admin Mode -->
        <button
          onclick="switchMode('admin')"
          class="group relative bg-stone-200 p-8 rounded-2xl shadow-lg hover:shadow-2xl transition-all border-b-4 border-stone-500 text-left"
        >
          <div
            class="absolute top-4 right-4 text-stone-600 opacity-20 group-hover:opacity-100 transition text-4xl"
          >
            <i class="fa-solid fa-gears"></i>
          </div>
          <h2 class="text-xl font-bold text-stone-800">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Admin)</h2>
          <p class="text-sm text-stone-500 mt-2">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</p>
        </button>
      </div>
    </div>

    <!-- === 2. CUSTOMER KIOSK PAGE === -->
    <div
      id="customer-page"
      class="hidden h-full flex flex-col relative bg-stone-50"
    >
      <!-- Header -->
      <header
        class="bg-stone-800 text-amber-100 p-4 flex justify-between items-center shadow-md"
      >
        <h1 class="font-bold text-lg">
          <i class="fa-solid fa-mug-hot mr-2"></i>Fresh Brew Queue
        </h1>
        <button
          onclick="location.reload()"
          class="text-xs border border-stone-600 px-2 py-1 rounded hover:bg-stone-700"
        >
          ‡∏≠‡∏≠‡∏Å
        </button>
      </header>

      <!-- Content -->
      <main
        class="flex-1 flex flex-col items-center justify-center p-6 text-center"
      >
        <!-- State 1: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß -->
        <div id="cust-state-idle" class="w-full max-w-sm">
          <div class="mb-8">
            <img
              src="https://img.icons8.com/clouds/200/coffee-to-go.png"
              alt="Coffee"
              class="mx-auto drop-shadow-lg"
            />
          </div>
          <h2 class="text-2xl font-bold text-stone-700 mb-2">
            ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡πÅ‡∏ü‡πÄ‡∏¢‡πá‡∏ô‡πÜ ‡∏™‡∏±‡∏Å‡πÅ‡∏Å‡πâ‡∏ß‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö?
          </h2>
          <p class="text-stone-500 mb-8">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏Ñ‡∏¥‡∏ß</p>
          <button
            onclick="getCustomerQueue()"
            class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold text-2xl py-6 rounded-2xl shadow-lg shadow-amber-500/30 transition transform active:scale-95 flex items-center justify-center gap-3"
          >
            <i class="fa-solid fa-ticket"></i> ‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏Ñ‡∏¥‡∏ß
          </button>
        </div>

        <!-- State 2: ‡∏ñ‡∏∑‡∏≠‡∏ö‡∏±‡∏ï‡∏£‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏¢‡∏π‡πà -->
        <div
          id="cust-state-waiting"
          class="hidden w-full max-w-sm bg-white p-8 rounded-3xl shadow-xl border border-stone-200"
        >
          <p class="text-stone-500 font-medium">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
          <div
            id="cust-my-queue"
            class="text-8xl font-black text-stone-800 my-4 tracking-tighter"
          >
            --
          </div>

          <div id="cust-status-box" class="bg-stone-100 rounded-xl p-4 mt-6">
            <div id="cust-status-text" class="text-lg font-bold text-stone-600">
              ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å...
            </div>
            <div id="cust-queue-left" class="text-sm text-stone-400 mt-1">
              ‡∏≠‡∏µ‡∏Å <span id="q-diff">0</span> ‡∏Ñ‡∏¥‡∏ß‡∏à‡∏∞‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏∏‡∏ì
            </div>
          </div>

          <p class="text-xs text-stone-400 mt-6">
            ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏Å‡πà‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß
          </p>
        </div>

        <!-- State 3: ‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß (Alert Mode) -->
        <div
          id="cust-state-ready"
          class="hidden absolute inset-0 bg-emerald-600 flex flex-col items-center justify-center text-white z-50 p-6 text-center"
        >
          <div class="animate-bounce text-6xl mb-6">üîî</div>
          <h1 class="text-4xl font-bold mb-2">‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß!</h1>
          <p class="text-emerald-100 text-xl mb-8">
            ‡πÄ‡∏ä‡∏¥‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏≤‡∏ô‡πå‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Ñ‡∏£‡∏±‡∏ö
          </p>
          <div
            class="bg-white text-emerald-800 px-8 py-4 rounded-2xl text-6xl font-black shadow-2xl mb-12"
          >
            <span id="cust-ready-number">--</span>
          </div>
          <button
            onclick="finishCustomerQueue()"
            class="bg-emerald-800 hover:bg-emerald-900 text-white px-8 py-3 rounded-full font-bold shadow-lg"
          >
            ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß / ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ
          </button>
        </div>
      </main>
    </div>

    <!-- === 3. MONITOR PAGE === -->
    <div
      id="monitor-page"
      class="hidden h-full flex flex-col bg-stone-900 relative"
    >
      <button
        onclick="location.reload()"
        class="absolute top-2 right-2 text-stone-600 hover:text-white z-20"
      >
        <i class="fa-solid fa-xmark"></i>
      </button>

      <div class="flex-1 flex flex-col lg:flex-row">
        <!-- Left: Main Queue -->
        <div
          id="monitor-main-bg"
          class="flex-1 flex flex-col items-center justify-center p-10 transition-colors duration-500 bg-stone-800"
        >
          <h2
            class="text-stone-400 text-3xl uppercase tracking-widest mb-4 font-light"
          >
            Now Serving
          </h2>
          <div
            id="mon-current"
            class="text-[12rem] md:text-[20rem] font-bold text-amber-400 leading-none drop-shadow-2xl font-mono"
          >
            --
          </div>
          <p
            id="mon-status"
            class="text-2xl text-emerald-400 mt-8 font-medium bg-emerald-400/10 px-6 py-2 rounded-full border border-emerald-400/20"
          >
            <i class="fa-solid fa-spinner fa-spin mr-2"></i> Waiting for order
          </p>
        </div>

        <!-- Right: History / Menu (Optional placeholder) -->
        <div
          class="hidden lg:flex w-1/3 bg-stone-950 border-l border-stone-800 p-8 flex-col"
        >
          <h3
            class="text-stone-500 font-bold uppercase tracking-wider mb-6 border-b border-stone-800 pb-2"
          >
            Last Called
          </h3>
          <div class="space-y-4 opacity-60">
            <div
              class="flex justify-between items-center text-stone-300 text-2xl"
            >
              <span>A002</span> <span class="text-sm text-stone-600">Done</span>
            </div>
            <div
              class="flex justify-between items-center text-stone-300 text-2xl"
            >
              <span>A001</span> <span class="text-sm text-stone-600">Done</span>
            </div>
          </div>
          <div class="mt-auto bg-stone-900 p-4 rounded-xl text-center">
            <p class="text-amber-500 font-serif italic text-lg">
              "Life begins after coffee"
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- === 4. ADMIN PAGE === -->
    <div id="admin-page" class="hidden h-full flex flex-col bg-gray-100">
      <header
        class="bg-white px-6 py-4 shadow-sm flex justify-between items-center"
      >
        <div>
          <h1 class="text-xl font-bold text-stone-800">‚òï Admin Control</h1>
          <p class="text-xs text-stone-500">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</p>
        </div>
        <button
          onclick="location.reload()"
          class="text-stone-400 hover:text-stone-800"
        >
          <i class="fa-solid fa-right-from-bracket"></i>
        </button>
      </header>

      <main class="flex-1 p-4 max-w-lg mx-auto w-full space-y-4">
        <!-- Cards -->
        <div class="grid grid-cols-2 gap-4">
          <div
            class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-emerald-500"
          >
            <p class="text-xs text-stone-400 uppercase">Current (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÅ‡∏•‡πâ‡∏ß)</p>
            <div
              id="admin-current"
              class="text-5xl font-bold text-emerald-600 mt-1"
            >
              --
            </div>
          </div>
          <div
            class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-amber-500"
          >
            <p class="text-xs text-stone-400 uppercase">Last (‡πÅ‡∏à‡∏Å‡πÅ‡∏•‡πâ‡∏ß)</p>
            <div id="admin-last" class="text-5xl font-bold text-amber-500 mt-1">
              --
            </div>
          </div>
        </div>

        <!-- Waiting Info -->
        <div
          class="bg-stone-200 rounded-lg p-3 text-center text-stone-600 font-medium"
        >
          ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠:
          <span id="admin-waiting" class="text-stone-900 font-bold text-lg"
            >0</span
          >
          ‡∏Ñ‡∏¥‡∏ß
        </div>

        <!-- Actions -->
        <button
          onclick="callNext()"
          class="w-full bg-emerald-600 active:bg-emerald-700 text-white p-8 rounded-2xl shadow-lg shadow-emerald-600/20 flex flex-col items-center justify-center gap-2 transition-transform active:scale-95"
        >
          <i class="fa-solid fa-bell text-4xl mb-2"></i>
          <span class="text-2xl font-bold">‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</span>
          <span class="text-emerald-200 text-sm">Call Next Queue</span>
        </button>

        <!-- Reset -->
        <div class="mt-8 pt-6 border-t border-stone-300">
          <button
            onclick="resetSystem()"
            class="w-full text-red-500 text-sm bg-red-50 hover:bg-red-100 py-3 rounded-lg border border-red-200 transition"
          >
            <i class="fa-solid fa-trash-can mr-1"></i> ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (Reset
            Day)
          </button>
        </div>
      </main>
    </div>

    <!-- Scripts -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
      import {
        getFirestore,
        doc,
        onSnapshot,
        runTransaction,
        setDoc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
      } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

      // === 1. CONFIGURATION ===
      const firebaseConfig = {
        apiKey: "AIzaSyAhKMt2-wTBqCUCC4mzHjt8tWxCHBJXC5I",
        authDomain: "student-data-app-1c677.firebaseapp.com",
        projectId: "student-data-app-1c677",
        storageBucket: "student-data-app-1c677.firebasestorage.app",
        messagingSenderId: "575305259038",
        appId: "1:575305259038:web:2ed2df837feb093185f60f",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      // Use global App ID if available, otherwise fallback
      const APP_ID =
        typeof __app_id !== "undefined" ? __app_id : "coffee-shop-demo";

      // Path: artifacts/{APP_ID}/public/data/queue_daily/status
      const QUEUE_DOC_REF = doc(
        db,
        "artifacts",
        APP_ID,
        "public",
        "data",
        "queue_daily",
        "status"
      );

      // Global State
      let currentQueue = 0;
      let lastQueue = 0;
      let myQueue = parseInt(localStorage.getItem("myQueue")) || 0;
      let currentMode = "landing";

      // === 2. AUTH & INIT ===
      async function init() {
        try {
          // Check for custom token first (Priority for Canvas environment)
          if (
            typeof __initial_auth_token !== "undefined" &&
            __initial_auth_token
          ) {
            await signInWithCustomToken(auth, __initial_auth_token);
            console.log("Signed in with custom token");
          } else {
            // Fallback to anonymous auth
            await signInAnonymously(auth);
            console.log("Signed in anonymously");
          }

          // Start listener
          setupListener();

          // Check state
          checkCustomerState();
        } catch (error) {
          console.error("Auth Error:", error);
          if (!firebaseConfig.apiKey)
            alert("‡πÑ‡∏°‡πà‡∏û‡∏ö Firebase Config: ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô Code ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
        }
      }

      // === 3. LISTENER ===
      function setupListener() {
        onSnapshot(QUEUE_DOC_REF, (docSnap) => {
          if (docSnap.exists()) {
            const data = docSnap.data();
            currentQueue = data.current || 0;
            lastQueue = data.last || 0;

            // Update UI
            updateUI();

            // Logic Customer Alert
            if (currentMode === "customer") checkCustomerAlert();
          } else {
            // Init Doc if not exists
            setDoc(QUEUE_DOC_REF, { current: 0, last: 0 });
          }
        });
      }

      // === 4. UI UPDATES ===
      function updateUI() {
        // Update Admin
        if (document.getElementById("admin-current")) {
          document.getElementById("admin-current").innerText = currentQueue;
          document.getElementById("admin-last").innerText = lastQueue;
          document.getElementById("admin-waiting").innerText = Math.max(
            0,
            lastQueue - currentQueue
          );
        }

        // Update Monitor
        if (document.getElementById("mon-current")) {
          const monDisplay = document.getElementById("mon-current");
          const monBg = document.getElementById("monitor-main-bg");
          const monStatus = document.getElementById("mon-status");

          monDisplay.innerText = currentQueue === 0 ? "--" : currentQueue;

          // Effect when queue changes
          if (currentQueue > 0) {
            monStatus.innerHTML = `<i class="fa-solid fa-bell"></i> ‡πÄ‡∏ä‡∏¥‡∏ç‡∏Ñ‡∏¥‡∏ß‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ${currentQueue} ‡∏Ñ‡∏£‡∏±‡∏ö`;
            // Flash effect
            monDisplay.classList.add("scale-110", "text-white");
            monBg.classList.remove("bg-stone-800");
            monBg.classList.add("bg-emerald-600");
            setTimeout(() => {
              monDisplay.classList.remove("scale-110", "text-white");
              monBg.classList.add("bg-stone-800");
              monBg.classList.remove("bg-emerald-600");
            }, 1500);
          }
        }

        // Update Customer Waiting Text
        if (myQueue > 0 && myQueue > currentQueue) {
          document.getElementById("q-diff").innerText = myQueue - currentQueue;
        }
      }

      // === 5. CUSTOMER LOGIC ===
      window.getCustomerQueue = async () => {
        try {
          if (!auth.currentUser) return; // Guard

          const newQ = await runTransaction(db, async (transaction) => {
            const sfDoc = await transaction.get(QUEUE_DOC_REF);
            if (!sfDoc.exists()) throw "Document does not exist!";

            const newLast = (sfDoc.data().last || 0) + 1;
            transaction.update(QUEUE_DOC_REF, { last: newLast });
            return newLast;
          });

          // Save to LocalStorage
          myQueue = newQ;
          localStorage.setItem("myQueue", newQ);
          checkCustomerState();
        } catch (e) {
          console.error("Get Queue Failed: ", e);
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏Ñ‡∏¥‡∏ß");
        }
      };

      function checkCustomerState() {
        if (myQueue > 0) {
          if (myQueue < currentQueue) {
            finishCustomerQueue();
            return;
          }

          document.getElementById("cust-state-idle").classList.add("hidden");
          document
            .getElementById("cust-state-waiting")
            .classList.remove("hidden");
          document.getElementById("cust-my-queue").innerText = myQueue;

          checkCustomerAlert();
        } else {
          document.getElementById("cust-state-idle").classList.remove("hidden");
          document.getElementById("cust-state-waiting").classList.add("hidden");
          document.getElementById("cust-state-ready").classList.add("hidden");
        }
      }

      function checkCustomerAlert() {
        if (myQueue === currentQueue && myQueue !== 0) {
          document
            .getElementById("cust-state-ready")
            .classList.remove("hidden");
          document.getElementById("cust-ready-number").innerText = myQueue;
          document.getElementById("cust-state-waiting").classList.add("hidden");

          if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
        }
      }

      window.finishCustomerQueue = () => {
        myQueue = 0;
        localStorage.removeItem("myQueue");
        document.getElementById("cust-state-ready").classList.add("hidden");
        checkCustomerState();
      };

      // === 6. ADMIN LOGIC ===
      window.callNext = async () => {
        try {
          if (!auth.currentUser) return;
          if (currentQueue >= lastQueue) return;

          await runTransaction(db, async (transaction) => {
            const sfDoc = await transaction.get(QUEUE_DOC_REF);
            if (!sfDoc.exists()) throw "Document does not exist!";
            const newCurrent = (sfDoc.data().current || 0) + 1;
            transaction.update(QUEUE_DOC_REF, { current: newCurrent });
          });
        } catch (e) {
          console.error("Call Next Failed: ", e);
        }
      };

      window.resetSystem = async () => {
        if (!auth.currentUser) return;
        if (
          confirm(
            "‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏õ‡πá‡∏ô 0?\n(‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏∑‡∏≠‡∏ö‡∏±‡∏ï‡∏£‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤)"
          )
        ) {
          await setDoc(QUEUE_DOC_REF, { current: 0, last: 0 });
        }
      };

      // === 7. ROUTING / NAVIGATION ===
      window.switchMode = (mode) => {
        currentMode = mode;
        document.getElementById("landing-page").classList.add("hidden");

        if (mode === "customer")
          document.getElementById("customer-page").classList.remove("hidden");
        if (mode === "monitor")
          document.getElementById("monitor-page").classList.remove("hidden");
        if (mode === "admin")
          document.getElementById("admin-page").classList.remove("hidden");

        checkCustomerState();
        updateUI();
      };

      // Start
      init();
    </script>
  </body>
</html>