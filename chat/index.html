<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó‡∏ä‡∏¥‡∏•‡πÜ üí¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Mali:wght@300;500;700&display=swap" rel="stylesheet" />
    <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° Font Awesome ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: "Mali", cursive; }
        
        /* ‡∏ã‡πà‡∏≠‡∏ô Scrollbar ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Animation ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏î‡πâ‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤ */
        @keyframes messagePop {
            0% { transform: scale(0.9); opacity: 0; transform-origin: bottom left; }
            100% { transform: scale(1); opacity: 1; transform-origin: bottom left; }
        }
        .msg-anim { animation: messagePop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á Default */
        .bg-theme-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); } /* ‡∏°‡πà‡∏ß‡∏á-‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô */
        .bg-theme-2 { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%); } /* ‡∏ä‡∏°‡∏û‡∏π‡∏´‡∏ß‡∏≤‡∏ô */
        .bg-theme-3 { background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); } /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß-‡∏ü‡πâ‡∏≤ */
        .bg-theme-4 { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); } /* ‡∏™‡πâ‡∏°-‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á */
        .bg-theme-5 { background-color: #1a202c; } /* Dark Mode */
    </style>
</head>

<body id="mainBody" class="bg-theme-1 h-[100dvh] w-full overflow-hidden text-gray-800 transition-colors duration-500">

    <!-- === 1. LOGIN SCREEN === -->
    <div id="loginScreen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-black/60 backdrop-blur-sm transition-opacity duration-500">
        <div class="bg-white/90 p-8 rounded-3xl shadow-2xl text-center max-w-sm w-full mx-4 border border-white/50">
            <div class="mb-4 text-6xl">üí¨</div>
            <h1 class="text-3xl font-bold mb-2 text-gray-800">‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó</h1>
            <p class="text-gray-500 mb-8 text-sm">‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÜ</p>
            
            <button id="btnLogin" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform active:scale-95 transition flex items-center justify-center gap-3">
                <i class="fa-brands fa-google"></i>
                ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google
            </button>
        </div>
    </div>

    <!-- === 2. CHAT APP === -->
    <div id="appScreen" class="hidden flex-col h-full max-w-3xl mx-auto bg-white/10 backdrop-blur-md shadow-2xl md:border-x border-white/10 relative">
        
        <!-- Header -->
        <header class="flex-none p-4 flex items-center justify-between bg-white/20 backdrop-blur-lg border-b border-white/10 shadow-sm z-20">
            <div class="flex items-center gap-3">
                <img id="userAvatar" src="" class="w-10 h-10 rounded-full border-2 border-white shadow-sm bg-gray-300 object-cover">
                <div>
                    <h2 id="userName" class="font-bold text-white text-sm leading-tight shadow-black drop-shadow-md">Loading...</h2>
                    <span class="text-[10px] text-white/80 bg-green-500/20 px-1.5 py-0.5 rounded-full border border-green-400/30">‚óè ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</span>
                </div>
            </div>

            <div class="flex gap-2">
                <!-- Theme Toggles -->
                <div class="hidden md:flex gap-1 bg-black/20 p-1 rounded-full backdrop-blur-sm">
                    <button onclick="changeTheme('bg-theme-1')" class="w-6 h-6 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 border border-white/50"></button>
                    <button onclick="changeTheme('bg-theme-2')" class="w-6 h-6 rounded-full bg-gradient-to-br from-pink-300 to-pink-500 border border-white/50"></button>
                    <button onclick="changeTheme('bg-theme-3')" class="w-6 h-6 rounded-full bg-gradient-to-br from-green-300 to-blue-300 border border-white/50"></button>
                    <button onclick="changeTheme('bg-theme-4')" class="w-6 h-6 rounded-full bg-gradient-to-br from-yellow-300 to-orange-400 border border-white/50"></button>
                    <button onclick="changeTheme('bg-theme-5')" class="w-6 h-6 rounded-full bg-gray-800 border border-white/50"></button>
                </div>
                
                <!-- Mobile Theme Menu (Toggle) -->
                <button onclick="document.getElementById('themeMenu').classList.toggle('hidden')" class="md:hidden w-8 h-8 rounded-full bg-white/20 hover:bg-white/30 text-white flex items-center justify-center">
                    <i class="fa-solid fa-palette"></i>
                </button>

                <button onclick="logout()" class="w-8 h-8 rounded-full bg-red-500/80 hover:bg-red-600 text-white flex items-center justify-center shadow">
                    <i class="fa-solid fa-power-off text-xs"></i>
                </button>
            </div>
        </header>

        <!-- Mobile Theme Dropdown -->
        <div id="themeMenu" class="hidden absolute top-16 right-4 bg-white p-3 rounded-xl shadow-xl z-30 grid grid-cols-5 gap-2">
             <button onclick="changeTheme('bg-theme-1')" class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 border-2 border-white ring-2 ring-gray-100"></button>
             <button onclick="changeTheme('bg-theme-2')" class="w-8 h-8 rounded-full bg-gradient-to-br from-pink-300 to-pink-500 border-2 border-white ring-2 ring-gray-100"></button>
             <button onclick="changeTheme('bg-theme-3')" class="w-8 h-8 rounded-full bg-gradient-to-br from-green-300 to-blue-300 border-2 border-white ring-2 ring-gray-100"></button>
             <button onclick="changeTheme('bg-theme-4')" class="w-8 h-8 rounded-full bg-gradient-to-br from-yellow-300 to-orange-400 border-2 border-white ring-2 ring-gray-100"></button>
             <button onclick="changeTheme('bg-theme-5')" class="w-8 h-8 rounded-full bg-gray-800 border-2 border-white ring-2 ring-gray-100"></button>
        </div>

        <!-- Chat Area -->
        <main id="chatContainer" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar scroll-smooth">
            <div class="text-center py-10 opacity-50 text-white">
                <i class="fa-regular fa-comments text-4xl mb-2"></i>
                <p>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢...</p>
            </div>
        </main>

        <!-- Input Area -->
        <footer class="flex-none p-3 bg-white/20 backdrop-blur-md border-t border-white/10">
            <form id="chatForm" class="flex gap-2 items-end max-w-3xl mx-auto">
                <div class="flex-1 bg-white rounded-2xl shadow-inner relative">
                    <input type="text" id="msgInput" class="w-full p-3 pl-4 rounded-2xl bg-transparent focus:outline-none text-gray-800 placeholder-gray-400" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." autocomplete="off">
                </div>
                <button type="submit" class="w-12 h-12 rounded-full bg-indigo-600 hover:bg-indigo-700 text-white shadow-lg transform active:scale-90 transition flex items-center justify-center">
                    <i class="fa-solid fa-paper-plane text-sm"></i>
                </button>
            </form>
        </footer>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, limit } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        // === CONFIG ===
        const firebaseConfig = {
            apiKey: "AIzaSyAhKMt2-wTBqCUCC4mzHjt8tWxCHBJXC5I",
            authDomain: "student-data-app-1c677.firebaseapp.com",
            projectId: "student-data-app-1c677",
            storageBucket: "student-data-app-1c677.firebasestorage.app",
            messagingSenderId: "575305259038",
            appId: "1:575305259038:web:2ed2df837feb093185f60f",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const APP_ID = typeof __app_id !== "undefined" ? __app_id : "default-app-id";
        let currentUser = null;

        // === UI ELEMENTS ===
        const loginScreen = document.getElementById('loginScreen');
        const appScreen = document.getElementById('appScreen');
        const chatContainer = document.getElementById('chatContainer');
        const chatForm = document.getElementById('chatForm');
        const msgInput = document.getElementById('msgInput');

        // === AUTH STATE ===
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loginScreen.classList.add('hidden'); // Fade out handled by CSS transition logic ideally, but hidden works
                loginScreen.style.opacity = '0';
                setTimeout(() => loginScreen.style.display = 'none', 500); // Wait for transition
                
                appScreen.classList.remove('hidden');
                appScreen.classList.add('flex');
                
                // Update UI
                document.getElementById('userName').innerText = user.displayName;
                document.getElementById('userAvatar').src = user.photoURL;

                // Start Chat Listener
                initChat();
            } else {
                currentUser = null;
                loginScreen.style.display = 'flex';
                setTimeout(() => loginScreen.style.opacity = '1', 10);
                appScreen.classList.add('hidden');
                appScreen.classList.remove('flex');
            }
        });

        // === LOGIN / LOGOUT ===
        document.getElementById('btnLogin').onclick = async () => {
            try { await signInWithPopup(auth, new GoogleAuthProvider()); } 
            catch (e) { alert(e.message); }
        };

        window.logout = () => {
            if(confirm("‡∏à‡∏∞‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏≠?")) signOut(auth);
        };

        // === THEME CHANGER ===
        // ‡πÇ‡∏´‡∏•‡∏î‡∏ò‡∏µ‡∏°‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏≤‡∏Å LocalStorage
        const savedTheme = localStorage.getItem('chatTheme') || 'bg-theme-1';
        document.getElementById('mainBody').className = `${savedTheme} h-[100dvh] w-full overflow-hidden text-gray-800 transition-colors duration-500`;

        window.changeTheme = (themeClass) => {
            const body = document.getElementById('mainBody');
            // ‡∏•‡∏ö‡∏ó‡∏∏‡∏Å class ‡∏ó‡∏µ‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ bg-theme-
            body.classList.forEach(cls => {
                if(cls.startsWith('bg-theme-')) body.classList.remove(cls);
            });
            body.classList.add(themeClass);
            localStorage.setItem('chatTheme', themeClass);
            // ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà
            document.getElementById('themeMenu').classList.add('hidden');
        };

        // === CHAT LOGIC ===
        function initChat() {
            // Path: artifacts/{appId}/public/data/chat_messages
            const messagesRef = collection(db, "artifacts", APP_ID, "public", "data", "chat_messages");
            // Query: ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤, ‡πÄ‡∏≠‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 50 ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
            const q = query(messagesRef, orderBy("timestamp", "asc"), limit(50));

            onSnapshot(q, (snapshot) => {
                chatContainer.innerHTML = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà (‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢) ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡∏ó‡∏≥ Diff ‡∏Å‡πá‡πÑ‡∏î‡πâ‡πÅ‡∏ï‡πà‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡πÑ‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
                
                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏´‡∏°
                if (snapshot.empty) {
                    chatContainer.innerHTML = `<div class="text-center py-10 opacity-50 text-white"><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°... ‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡∏´‡∏ô‡πà‡∏≠‡∏¢!</p></div>`;
                    return;
                }

                let lastSenderId = null;

                snapshot.forEach((doc) => {
                    const msg = doc.data();
                    renderMessage(msg, msg.uid === currentUser.uid, lastSenderId === msg.uid);
                    lastSenderId = msg.uid;
                });

                // Auto Scroll to bottom
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });
        }

        function renderMessage(msg, isMe, isContinuous) {
            const div = document.createElement('div');
            // ‡∏à‡∏±‡∏î‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢ (‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô) ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Ç‡∏ß‡∏≤ (‡πÄ‡∏£‡∏≤)
            div.className = `flex w-full mb-1 ${isMe ? 'justify-end' : 'justify-start'} msg-anim`;
            
            // ‡πÄ‡∏ß‡∏•‡∏≤
            const time = msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'}) : '...';

            let avatarHtml = '';
            // ‡πÇ‡∏ä‡∏ß‡πå‡∏£‡∏π‡∏õ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏£‡∏≤ ‡πÅ‡∏•‡∏∞ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á
            if (!isMe && !isContinuous) {
                avatarHtml = `<img src="${msg.photoURL}" class="w-8 h-8 rounded-full mr-2 shadow-sm border border-white/30 self-end mb-1">`;
            } else if (!isMe && isContinuous) {
                // ‡πÄ‡∏ß‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô
                avatarHtml = `<div class="w-8 h-8 mr-2"></div>`;
            }

            // ‡∏™‡∏µ‡∏Ç‡∏≠‡∏á Bubble
            // ‡πÄ‡∏£‡∏≤: ‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏î‡∏≥ (‡∏î‡∏π‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏ö‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ)
            // ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô: ‡∏™‡∏µ‡∏î‡∏≥‡πÉ‡∏™‡πÜ ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡πÉ‡∏™‡πÜ
            const bubbleClass = isMe 
                ? 'bg-white text-gray-800 rounded-l-2xl rounded-tr-2xl rounded-br-sm' 
                : 'bg-black/40 backdrop-blur-sm text-white rounded-r-2xl rounded-tl-2xl rounded-bl-sm';

            div.innerHTML = `
                ${avatarHtml}
                <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'} max-w-[70%]">
                    ${(!isMe && !isContinuous) ? `<span class="text-[10px] text-white/80 ml-1 mb-0.5">${msg.displayName}</span>` : ''}
                    <div class="${bubbleClass} px-4 py-2 shadow-md break-words min-w-[2rem] text-left">
                        ${msg.text}
                    </div>
                    <span class="text-[9px] text-white/60 mt-0.5 mx-1">${time}</span>
                </div>
            `;

            chatContainer.appendChild(div);
        }

        // === SEND MESSAGE ===
        chatForm.onsubmit = async (e) => {
            e.preventDefault();
            const text = msgInput.value.trim();
            if (!text) return;

            const tempText = text;
            msgInput.value = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÄ‡∏£‡πá‡∏ß

            try {
                const messagesRef = collection(db, "artifacts", APP_ID, "public", "data", "chat_messages");
                await addDoc(messagesRef, {
                    text: tempText,
                    uid: currentUser.uid,
                    displayName: currentUser.displayName,
                    photoURL: currentUser.photoURL,
                    timestamp: serverTimestamp()
                });
            } catch (err) {
                console.error(err);
                alert("‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏õ‡πÅ‡∏Æ‡∏∞: " + err.message);
                msgInput.value = tempText; // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏û‡∏±‡∏á
            }
        };

    </script>
</body>
</html>
